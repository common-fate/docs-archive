---
sidebar_position: 8
---

# Sharing of AWS Config file with the team

Sharing consistent AWS profiles amongst team members can be helpful. When writing scripts and documentation it allows you to concisely refer to a particular role that a team member should be using to do something. 
For example: ”run your development deploys using the cf-dev role”.

Granted CLI provides a Profile Registry feature. A profile registry is a git repository which is a central store of AWS profile configuration which is then synced to the default aws config file `~/.aws/config`

![](/img/profile-registry/overview.png)

## 1. Setting up a Profile Registry

### Using Granted CLI to setup a Profile Registry 

#### 1. Create a Profile Registry Folder
You can quickly move the contents of your ~/.aws/config and setup a Profile Registry repository with the following command:

```
granted registry setup
```

**_NOTE:_**  This will copy all the profiles inside your ~/.aws/config file to the config file inside created Profile Registry. 

The output of this command is a "granted-registry" folder created in your current working directory with the following files:
```
├── .git
├── config
└── granted.yml
```
#### 2. Add a local repository to Git-based source code repository hosting service
You need to manually add this repository to your organization's repository. For github, you can follow this [link](https://docs.github.com/en/get-started/importing-your-projects-to-github/importing-source-code-to-github/adding-locally-hosted-code-to-github#adding-a-local-repository-to-github-using-git).

### Manually setting a Profile Registry
You can add any git repository to Granted CLI. Granted by default will look for `granted.yml` file in the root of the repository. If you want to specify a different YAML file then [follow this link](#2-specifying-a-different-yaml-file)

```
granted registry add git@github.com:octo/granted-registry.git
```

The `granted.yml` file points to the AWS config files in the repository which should be synced. These config files must exist in the repository; paths pointing outside the repository such as `../config` are not permitted. Multiple config files are allowed and are merged together when syncing from the registry. 


A valid `granted.yml` requires an `awsConfig` key to be present. For example:
```
awsConfig:
  - ./config
  - ./other-config
```

In the above example, AWS profiles inside `config` & `other-config` files will be merged and synced to your local `./aws/config` file.

:::info
If there are any duplicate profile names in the same repository, the second one will overwrite and only single profile values will be synced.
:::info

## 2. Adding a Profile Registry

### 1. 'granted.yml' file in root

If the provided git URL has `granted.yml` in the root of the directory then run `granted registry add <your-repo-git-url>` command to add a profile registry. Both SSH and HTTPS formats are accepted.

```
granted registry add <your-repo-git-url>
```

This will clone `<your-repo-git-url>`, load all the AWS config files configured in the `granted.yml` file and sync. 

You should be able to see a Granted generated section inside your `/.aws/config` file such as:

```
# Granted-Registry Autogenerated Section. DO NOT EDIT.
# This section is automatically generated by Granted (https://granted.dev). Manual edits to this section will be overwritten.
# To edit, clone your profile registry repo, edit granted.yml, and push your changes. You may need to make a pull request depending on the repository settings.
# To stop syncing and remove this section, run 'granted registry remove
[granted_registry_start git@github.com:octo/granted-registry.git]

[profile dev]
sso_start_url  = <https://example.awsapps.com/start>
sso_region     = <your-sso-region>
sso_account_id = <your-sso-account-id>
sso_role_name  = <your-sso-role-name>

[granted_registry_end git@github.com:octo/granted-registry.git]
```
:::info
To avoid confusion, synced profiles are placed into a designated region in the file as shown above. This allows users to have a mix of both synced and regular profiles in their config file:
:::info

### 2. Specifying a different YAML file.
If you want to specify a different YAML file, then run:

```
granted registry add <your-repo-url>/<filname.yml>
```

### 3. Specifying only a subfolder 
If you have subfolder such as: 

```
.
├── team_dev
│   ├── config1
│   ├── config2
│   ├── granted.yml
│  
├── team_ops
│   ├── config3
│   ├── config4
│   ├── custom.yml

```

Then you can specify only the subfolder having `granted.yml` as:

```
granted registry add <your-repo-url.git>/<sub-folder>/
```

Or with custom file name as:

```
granted registry add <your-repo-url.git>/<sub-folder>/<filename.yml>
```

## 3. Syncing a Profile Registry 
Adding a Profile Registry is sufficient to sync the config file. Granted CLI will automatically sync your profile repositories once per day when you run `granted credential-process` or `asssume` command by default.

However, if you want to perform instant sync then you can run:

```
granted registry sync
```

This will loop over the configured profile registries, pull the latest change from the remote origin and perform a sync operation. 

:::info
When you are using AWS CLI with `granted credential-process` you won't be notified when the daily Profile Registry sync fails because AWS expects specific JSON STDOUT when configured with sourcing credentials with an external process. In that case, you can run `assume` or `granted registry sync` to see the issue. Add verbose flag like `assume --verbose` to see the Debug logs. 
:::info

## 4. Removing a Profile Registry
To unsubscribe a Profile Registry you can run:
```
granted registry remove
```
This will display all the subscribed Profile Registries and prompt you to choose a registry to unsubscribe.
